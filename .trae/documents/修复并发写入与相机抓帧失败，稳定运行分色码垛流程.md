## 问题与目标
- 修复 Windows 上对 data/status.json 的并发写导致的拒绝访问（PermissionError）。
- 修复摄像头抓帧失败（MSMF 后端报错），保证 Detect 预览和坐标采集正常。
- 保持现有流程与接口，提升健壮性与鲁棒性。

## 并发写入修复（状态文件）
- 调整安全写策略：
  1) 将 common_io.safe_write_json 改为“直接写入 + 截断”的方式（open(path, 'w')），不再使用 os.replace，从而避免被其他进程打开时的替换失败；
  2) 保留简易锁（.lock 文件）以防多进程同时写同一文件，写完后释放锁；
  3) 在 main.py 内仅在状态变更时调用 save_status，避免高频写；Detect/ArmControl 继续只读 status.json、用 flag 文件（detect_done/arm_ready/arm_done）向 main 报告阶段完成。
- 重试与回退：在 safe_write_json 失败时，增加短间隔重试（最多 N 次，间隔 50–100ms）；失败则记录错误并不中断主流程（可维持旧状态一次循环）。

## 摄像头抓帧修复（预览与采集）
- Detect.py 增加摄像头打开策略：
  1) 依次尝试索引 0→1→2→3（可配置），后端优先 CAP_DSHOW，其次默认；
  2) 打开后进行热身读取 10 帧，若连续失败则切换索引或后端；
  3) 在运行时若抓帧失败连续超过阈值，打印告警并轮询切换到备用索引/后端；
- 降噪与稳定：对颜色掩码结果做面积阈值与稳定帧计数（例如必须连续 M 帧发现目标才采信），减少误触发。

## 代码改动清单
- Block_Palletizing/common_io.py：
  - 修改 safe_write_json：使用 open(path, 'w') 写入 + 锁；支持重试。
- Block_Palletizing/main.py：
  - 维持现有 flag 推进；保证 save_status 只在状态变更时调用。
- Block_Palletizing/Detect.py：
  - 初始化摄像头时加入多索引、多后端尝试；运行时抓帧失败自动切换；
  - 颜色检测增加稳定帧判定；仍只在“capturing”阶段写 blocks_<cycle>.json 与 detect_done.flag。

## 验证步骤
- 在 E:\DualArm\DobotMagician 下运行：python E:\DualArm\Block_Palletizing\main.py
- 观察：
  - 不再出现对 status.json 的 PermissionError；
  - Detect 预览正常，能在机械臂就位后采集左右坐标并停止写入；
  - ArmControl 完成分拣后回到安全位，主控进入下一轮。

## 配置项与可调参数
- 摄像头索引列表与后端顺序（Detect.py 顶部配置）。
- 面积阈值与稳定帧数 M；
- safe_write_json 的重试次数与间隔；
- 现有 config.json 的 stop_pose、bins、z_workplane、Z 参数与 flip_y。

## 风险与回退
- 直接写文件不是完全原子，但在单写者 + 读者的场景下可满足需求；如后续需要更严谨的原子写，可引入临时文件写 + Windows API MoveFileEx（使用允许替换标志）。
- 若摄像头硬件或驱动异常，仍可能无法抓帧；已提供多后端与索引切换作为回退。